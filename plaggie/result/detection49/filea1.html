<HTML>
<HEAD>
<TITLE>plaggie_data/22/PlayGame.java</TITLE>
</HEAD>
<BODY>
<H1>plaggie_data/22/PlayGame.java</H1>
<CODE><PRE>
<A NAME="match3"></A><A HREF="fileb1.html#match3" TARGET="right">3</A>:package controllers;
3:
3:import com.google.gson.Gson; 
3:import io.javalin.Javalin;
3:import java.io.IOException;
3:import java.util.Queue;
3:import models.GameBoard;
3:import models.Message;
3:import models.Move;
3:import models.Player;
3:import org.eclipse.jetty.websocket.api.Session;
3:
3:class PlayGame {
3:
3:  private static final int PORT_NUMBER = 8080;
3:
3:  private static Javalin app;
3:  
3:  public static GameBoard board;
  
  //Checks if the game is a Draw after a move 
  public static boolean isDraw(GameBoard b) {
    for (char[] r : b.getBoardState()) {
      for (char a  : r) {
        if (a == 0) {
          return false;
        }
      }
    }
    return true;
  }
  
  //checks if the game is won after a move 
  public static boolean isWinningMove(GameBoard b) {
    char[][] bs = b.getBoardState();
    if ((bs[0][0] == bs[0][1] &amp;&amp; bs[0][1] == bs[0][2] &amp;&amp; bs[0][2] != 0)  //ROWS
        || (bs[1][0] == bs[1][1] &amp;&amp; bs[1][1] == bs[1][2] &amp;&amp; bs[1][2] != 0)
        || (bs[2][0] == bs[2][1] &amp;&amp; bs[2][1] == bs[2][2] &amp;&amp; bs[2][2] != 0)
        
        || (bs[0][0] == bs[1][0] &amp;&amp; bs[1][0] == bs[2][0] &amp;&amp; bs[2][0] != 0)  //COLLUMS
        || (bs[0][1] == bs[1][1] &amp;&amp; bs[1][1] == bs[2][1] &amp;&amp; bs[2][1] != 0) 
        || (bs[0][2] == bs[1][2] &amp;&amp; bs[1][2] == bs[2][2] &amp;&amp; bs[2][2] != 0) 
        
        || (bs[0][0] == bs[1][1] &amp;&amp; bs[1][1] == bs[2][2] &amp;&amp; bs[2][2] != 0) 
        || (bs[0][2] == bs[1][1] &amp;&amp; bs[1][1] == bs[2][0] &amp;&amp; bs[2][0] != 0) //diagonals
        
        
        ) {
      return true;
    }
    return false;
  }
  
  //checks if move is valid according to board state
  public static boolean isValidMove(int x, int y, GameBoard b) {
    //check to see if the move is valid and set variable 
    if (board.getBoardState()[x][y] != 0) {
      return false;
    } 
    return true;  
  }

  //gets the player from the board acording to their ID = (1||2)
  public static Player getPlayerById(int id, GameBoard b) {

    if (id == 1) {
      return b.getP1();
    }
    return b.getP2();
  }
  
  /** Main method of the application.
   * @param args Command line arguments
   */
<A NAME="match0"></A><A HREF="fileb1.html#match0" TARGET="right">0</A>:  public static void main(final String[] args) {
0:
0:
0:
0:    // Test Echo Server
0:    if (app=="/echo") {
0:      ctx.result(ctx.body());
0:    }
0:
0:    // starts a new game
0:    if (app=="/newgame") {
0:      ctx.redirect("/tictactoe.html");
0:    }
0:    
0:    //adds player 2 and starts game 
0:    if (app=="/startgame") {
0:      
0:      //get the body response ie what symbol of p1 is format type=X
0:      String response = ctx.body();
0:      char moveType = response.charAt(response.length() - 1);   //extract type from last char
      
      //create p1
      Player p1 = new Player(1, moveType);
      
      //create a gameBoard
      board = new GameBoard();
      board.setP1(p1);
      
      
      //change GameBoard object to JSON
      String jsonBoard = new Gson().toJson(board);
      
      //send result back in JSON format 
      ctx.result(jsonBoard);
      
    }
    
    
    //handles the joining of player two 
    if (app=="/joingame") {
      
      //retrieve the moveType from board; set it opposite of opponent 
      char opType = board.getP1().getType();
      char moveType;
      
      if (opType == 'X') {
        moveType = 'O';
      } else { //opType == O
        moveType = 'X';
      }
      
      //create player two
      Player p2 = new Player(2, moveType);
      board.setP2(p2);
      
      //start game
      board.setGameStarted(true);
      
      //redirect and update view for users 
      String jsonBoard = new Gson().toJson(board);
      ctx.redirect("/tictactoe.html?p=2");
      sendGameBoardToAllPlayers(jsonBoard);
      
    }
    
    
    //handles possible moves 
    if (app=="/move/:playerId") {
      
      //get player ID and response 
      String pidStr = ctx.pathParam("playerId");
      int playerId = Integer.parseInt(pidStr);
<A NAME="match4"></A><A HREF="fileb1.html#match4" TARGET="right">4</A>:      String response = ctx.body();
4:      
4:      //get the x,y coordinates of move values hard coded since response is expected 
4:      int x = Integer.parseInt(String.valueOf(response.charAt(2)));
4:      int y = Integer.parseInt(String.valueOf(response.charAt(6)));
4:      
4:      //check if move is valid (ie taken up) and get player 
4:      boolean isValid = isValidMove(x, y, board);
      Player p = getPlayerById(playerId, board);
      
      //create move with the information 
      Move usrMove = new Move(p, x, y);
      Message msg;
      
      
      
      //case1:game is over and there's a winner or draw 
      if (!board.getGameStarted() &amp;&amp; (board.getWinner() != 0 || board.getIsDraw()))  { 
        msg = new Message(false, 345, "you're still here? the game is over.. go home");
      
        //case2: game has yet to start so no letting them move 
      } else if (!board.getGameStarted()) {  //game has not started
        msg = new Message(false, 340, "the game has not started, be patient");
        
      //case6: player is trying to go when not their turn 
      } else if ((board.getTurn() != playerId)) { //turn != ID 
        msg = new Message(false, 9000, "you're power level is not that high, wait your turn");
        
      //valid move is made
      } else if (isValid) { 
        //change board state
        board.setBoardState(usrMove);
        //case3: if this is the winner then set message and end game 
        if (isWinningMove(board)) {
          msg = new Message(isValid, 101, "You've Totally Won player: " + pidStr);
          board.setWinner(playerId);
          board.setGameStarted(false);
          
          //case:4 there has occurred a tie 
<A NAME="match2"></A><A HREF="fileb1.html#match2" TARGET="right">2</A>:        } else if (isDraw(board)) {
2:          board.setIsDraw(true);
2:          msg = new Message(isValid, 389, "Cats Game; issa tie");
2:          
2:          //case5: this is a valid move with no winner 
2:        } else {
2:          msg = new Message(isValid, 100, "");
2:        }
        
        //update who's turn it is on the board
        if (playerId == 1) {
          board.setTurn(2);
        } else { //turn == 2
          board.setTurn(1);
        }
        
      //case6: all good except someone marked there already 
      } else {
        msg = new Message(isValid, 270, "Error: move already played");
      }
      
     
      //convert board and message to JSON; send to user and update view 
      String jsonMessage = new Gson().toJson(msg);
<A NAME="match1"></A><A HREF="fileb1.html#match1" TARGET="right">1</A>:      String jsonBoard = new Gson().toJson(board);
1:      sendGameBoardToAllPlayers(jsonBoard);
1:      ctx.result(jsonMessage);
1:      
1:      
1:    }
1:    
1:    
1:
1:    // Web sockets - DO NOT DELETE or CHANGE
1:    app.ws("/gameboard", new UiWebSocket());
1:    
1:  }
1:
1:  /** Send message to all players.
1:   * @param gameBoardJson Gameboard JSON
1:   * @throws IOException Websocket message send IO Exception
1:   */
1:  private static void sendGameBoardToAllPlayers(final String gameBoardJson) {
1:    Queue&lt;Session&gt; sessions = UiWebSocket.getSessions();
1:    for (Session sessionPlayer : sessions) {
1:      try {
1:        sessionPlayer.getRemote().sendString(gameBoardJson);
1:     
1:      } catch (IOException e) {
        // Add logger here
      }
    }
  }

  public static void stop() {
    app.stop();
  }
}
</PRE></CODE>
</BODY>
</HTML>
